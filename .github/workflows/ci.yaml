# Do not manually edit this file, it is automatically generated
jobs:
  build-celery:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: 'extra-substituters = https://cache.jmbaur.com

          extra-trusted-public-keys = cache.jmbaur.com:C3ku8BNDXgfTO7dNHK+eojm4uy7Gvotwga+EV0cfhPQ=

          '
    - env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        CACHE_SIGNING_KEY: ${{ secrets.CACHE_SIGNING_KEY }}
      name: Build celery
      run: 'substituter="s3://cache?region=auto&scheme=https&endpoint=34455c79130a7a7a9495dc2123622e59.r2.cloudflarestorage.com"


        echo -n "$CACHE_SIGNING_KEY" >signing-key.pem


        toplevel=$(nix build --print-build-logs --no-link --print-out-paths "$PWD#nixosConfigurations.celery.config.system.build.toplevel")

        nix-store --query --requisites "$toplevel" >requisites

        nix store sign --key-file signing-key.pem --stdin --verbose <requisites

        nix copy --debug --to "$substituter" --stdin --verbose <requisites

        '
  build-squash:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: 'extra-substituters = https://cache.jmbaur.com

          extra-trusted-public-keys = cache.jmbaur.com:C3ku8BNDXgfTO7dNHK+eojm4uy7Gvotwga+EV0cfhPQ=

          '
    - env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        CACHE_SIGNING_KEY: ${{ secrets.CACHE_SIGNING_KEY }}
      name: Build squash
      run: 'substituter="s3://cache?region=auto&scheme=https&endpoint=34455c79130a7a7a9495dc2123622e59.r2.cloudflarestorage.com"


        echo -n "$CACHE_SIGNING_KEY" >signing-key.pem


        toplevel=$(nix build --print-build-logs --no-link --print-out-paths "$PWD#nixosConfigurations.squash.config.system.build.toplevel")

        nix-store --query --requisites "$toplevel" >requisites

        nix store sign --key-file signing-key.pem --stdin --verbose <requisites

        nix copy --debug --to "$substituter" --stdin --verbose <requisites

        '
name: ci
'on':
  push:
    branches:
    - main
  workflow_dispatch: {}
